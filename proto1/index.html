<!doctype html>
<html>
<head>
	<script src="/socket.io/socket.io.js" type="text/javascript"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
</head>
<style>
body{
	position: relative;
	background-color: #ccc;
}
#map{
	position:absolute;
	width:256px;
	height:256px;
	overflow: hidden;
	left:0;
	top:0;
	background-color:white;
}
.msg {
	position:absolute;
}
</style>
<body>
	<input id="txt" type="text" style="width:256px;margin:auto;display:block"/>
	<div id="map">
	</div>
	
</div>

<script>
function main() {
	var clicked = false, $map = $('#map'), socket;

	socket = io.connect('http://localhost:8989');
	socket.on('connect', function(){
		socket.emit('update_pos', {x:parseInt($map.css('left')), y:parseInt($map.css('top'))});
	});

	$map.mousedown(function(e){
		console.log('mousedown');
		var x = e.pageX, y = e.pageY;
		function unbind(){$map.unbind('mousemove').unbind('mouseup').unbind('mouseleave')}
		$map.mousemove(function(e){
			console.log('mousemove');
			var px = parseInt($map.css('left')) + (e.pageX - x) + 'px',
				py = parseInt($map.css('top')) + (e.pageY - y) + 'px';
			console.log(px + ' ' + py);
			$map.css('left', px).css('top', py);
			x = e.pageX, y = e.pageY;

			socket.emit('update_pos', {x:x, y:y});
		}).mouseup(function(e){
			console.log('mouseup');
			unbind();
		}).mouseleave(function(e){
			console.log('mouseleave');
			unbind();
		});
	});

	$map.dblclick(function(e){
		var x = e.pageX, y = e.pageY, txt = $('#txt').val();
		if(!txt) return;

		var msg = {x:x, y:y, message:txt};
		console.log('send_msg: ' + JSON.stringify(msg));
		socket.emit('send_msg', msg);
	});

	socket.on('recv_msg', function (data) {
		var msg = $('<span id='+data.id+' class="msg">'+data.message+'</span>').css('left', data.x+'px').css('top', data.y+'px');
		$('body').append(msg);
	});
}

$(function(){
	main();
});

</script>
</body>
</html>